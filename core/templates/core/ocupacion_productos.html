{% extends 'core/base.html' %}

{% block content %}

<a href="?filtro=lleno">Brincolines</a> |
<a href="?filtro=parcial">Manteleria, Mueble y Mecanicos</a> |
<a href="?filtro=todos">Todos</a>

<h2>Ocupación de Productos (Próximos 7 días)</h2>

<form method="get" style="margin-bottom:15px;">
    <label>Mostrar:</label>
    <select name="filtro" onchange="this.form.submit()">
        <option value="todos" {% if filtro == 'todos' %}selected{% endif %}>Todos</option>
        <option value="parcial" {% if filtro == 'parcial' %}selected{% endif %}>Solo parciales</option>
        <option value="lleno" {% if filtro == 'lleno' %}selected{% endif %}>Solo llenos</option>
    </select>
</form>

<div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-secondary"
       href="?week={{ prev_week|date:'Y-m-d' }}&filtro={{ filtro }}">
        ⬅ Semana anterior
    </a>

    <strong>
        {{ inicio|date:"d M Y" }} - {{ fin|date:"d M Y" }}
    </strong>

    <a class="btn btn-outline-secondary"
       href="?week={{ next_week|date:'Y-m-d' }}&filtro={{ filtro }}">
        Semana siguiente ➡
    </a>
</div>

<table border="1" cellpadding="8" cellspacing="0" style="width:100%; border-collapse: collapse;">
    <thead>
        <tr style="background:#f0f0f0;">
            <th>Producto</th>
            {% for dia in dias %}
                <th>{{ dia|date:"d M" }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for fila in data %}
        <tr>
            <td>{{ fila.producto.nombre }}</td>
            {% for estado in fila.estados %}
                <td class="celda-calendario"
                    data-fecha="{{ estado.fecha|date:'Y-m-d' }}"
                    style="text-align:center;
                        {% if estado.estado == 'LIBRE' %}background:#c8e6c9;{% endif %}
                        {% if estado.estado == 'PARCIAL' %}background:#fff9c4;{% endif %}
                        {% if estado.estado == 'LLENO' %}background:#ffcdd2;{% endif %}
                        {% if estado.estado == 'INACTIVO' %}background:#e0e0e0;{% endif %}">
                    {{ estado.estado }}
                </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<br>

<div>
    <strong>Leyenda:</strong>
    <span style="background:#c8e6c9;padding:5px;">LIBRE</span>
    <span style="background:#fff9c4;padding:5px;">PARCIAL</span>
    <span style="background:#ffcdd2;padding:5px;">LLENO</span>
    <span style="background:#e0e0e0;padding:5px;">INACTIVO</span>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCalendario" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Productos rentados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const celdas = document.querySelectorAll('.celda-calendario');

    celdas.forEach(celda => {
        celda.addEventListener('click', async () => {
            const fecha = celda.dataset.fecha;

            try {
                const res = await fetch(`/ocupacion/${fecha}/`);
                if (!res.ok) throw new Error('Error backend');

                const productos = await res.json();
                let html = '';

                if (productos.length === 0) {
                    html = "<p>No hay productos rentados este día.</p>";
                } else {
                    html = `
                    <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Última renta</th>
                            <th>Último mantenimiento</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                    `;

                    productos.forEach(p => {
                        const hoy = new Date().toISOString().split('T')[0];
                        const yaMantenidoHoy = p.fecha_ultimo_mantenimiento === hoy;

                        html += `
                        <tr>
                            <td>${p.nombre}</td>
                            <td>${p.cantidad_rentada}</td>
                            <td>${p.fecha_ultima_renta || 'N/A'}</td>
                            <td>${p.fecha_ultimo_mantenimiento || 'N/A'}</td>
                            <td>
                                <button class="btn btn-sm btn-success"
                                    ${yaMantenidoHoy ? 'disabled' : ''}
                                    onclick="marcarMantenimiento(${p.producto_id}, '${fecha}')">
                                    ${yaMantenidoHoy ? 'Mantenido hoy' : 'Marcar mantenimiento'}
                                </button>
                            </td>
                        </tr>
                        `;
                    });

                    html += '</tbody></table>';
                }

                document.getElementById('modal-body').innerHTML = html;
                new bootstrap.Modal(document.getElementById('modalCalendario')).show();

            } catch (err) {
                console.error(err);
                alert('No se pudieron cargar los datos del día');
            }
        });
    });
});

async function marcarMantenimiento(producto_id, fecha) {
    try {
        const res = await fetch("/marcar_mantenimiento/", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ producto_id })
        });

        const data = await res.json();

        if (data.status === 'ok') {
            alert(`Mantenimiento marcado: ${data.fecha_ultimo_mantenimiento}`);
            const modal = bootstrap.Modal.getInstance(
                document.getElementById('modalCalendario')
            );
            modal.hide();
        } else {
            alert('Error al marcar mantenimiento');
        }
    } catch (err) {
        console.error(err);
        alert('Error al registrar mantenimiento');
    }
}
</script>

{% endblock %}
