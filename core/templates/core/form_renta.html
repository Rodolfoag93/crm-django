{% extends 'core/base.html' %}
{% block content %}

<h2>{% if form.instance.pk %}Editar Renta{% else %}Nueva Renta{% endif %}</h2>

{% if messages %}
  {% for message in messages %}
    {% if "RENTA_CREADA::" in message|stringformat:"s" %}
        <div style="background:#e0ffe0; color:#060; padding:10px; border-radius:6px; margin-bottom:15px;">
            Renta creada correctamente.
        </div>

        <script>
            const rentaId = "{{ message|stringformat:'s' }}".split("::")[1];

            // Abrir ticket en nueva pesta√±a
            window.open(`/rentas/ticket/${rentaId}/`, "_blank");

            // Limpiar el formulario
            const form = document.querySelector('form');
            form.reset();

            // Limpiar la tabla de productos
            const tbody = document.querySelector("#tabla-productos tbody");
            tbody.innerHTML = "";

            // Resetear total y productos_data
            document.getElementById("total-general").textContent = "0.00";
            document.getElementById("precio-total").value = "0.00";
            document.getElementById("productos-data").value = "[]";
            document.getElementById("restante").value = "0.00";

            // Limpiar input cliente
            document.getElementById("cliente-input").value = "";
            document.getElementById("cliente-id").value = "";
            document.getElementById("calle_y_numero").value = "";
            document.getElementById("colonia").value = "";
            document.getElementById("ciudad_o_municipio").value = "";
        </script>
    {% else %}
        <div style="background:#ffe0e0; color:#900; padding:10px; border-radius:6px; margin-bottom:15px; font-weight:bold;">
            {{ message }}
        </div>
    {% endif %}
  {% endfor %}
{% endif %}

{% if form.instance.estado_entrega == "EN_RUTA" or form.instance.estado_entrega == "ENTREGADO" %}
<div style="background:#ffe0e0; color:#900; padding:10px; border-radius:5px; margin-bottom:15px;">
    ‚ö†Ô∏è Esta renta ya est√° <strong>{{ form.instance.estado_entrega }}</strong> y no puede modificarse.
</div>
{% endif %}

<form method="POST">
    {% csrf_token %}

    <!-- ========================= -->
    <!--   AUTOCOMPLETAR CLIENTE   -->
    <!-- ========================= -->
    <label for="cliente-input">Cliente:</label>
    <input type="text" id="cliente-input" autocomplete="off" placeholder="Nombre o tel√©fono"
           value="{{ form.instance.cliente.nombre|default:'' }}">
    <ul id="sugerencias-clientes"></ul>
    <input type="hidden" name="cliente" id="cliente-id" value="{{ form.instance.cliente.id|default:'' }}">

    <hr>

    <!-- ===================== -->
    <!--    DATOS DE EVENTO    -->
    <!-- ===================== -->
    <h4>Datos del Evento</h4>
    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 10px;">
        <div>
                <label>Fecha</label>
                {{ form.fecha_renta }}
        </div>

        <div>
                <label>Hora inicio</label>
                {{ form.hora_inicio }}
        </div>

        <div>
            <label>Hora fin</label>
            {{ form.hora_fin }}
        </div>
    </div>

    <!-- ========================= -->
    <!--  DIRECCI√ìN DEL EVENTO     -->
    <!-- ========================= -->
    <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 10px;">
        <div>
            <label for="calle_y_numero">Calle y n√∫mero:</label><br>
            <input type="text" name="calle_y_numero" id="calle_y_numero" value="{{ form.instance.calle_y_numero|default:'' }}">
        </div>
        <div>
            <label for="colonia">Colonia:</label><br>
            <input type="text" name="colonia" id="colonia" value="{{ form.instance.colonia|default:'' }}">
        </div>
        <div>
            <label for="ciudad_o_municipio">Ciudad / Municipio:</label><br>
            <input type="text" name="ciudad_o_municipio" id="ciudad_o_municipio" value="{{ form.instance.ciudad_o_municipio|default:'' }}">
        </div>
    </div>

    <hr>

    <!-- ============================ -->
    <!--   BUSCADOR Y TABLA PRODUCTOS -->
    <!-- ============================ -->
    <h3>Agregar Productos</h3>
    <input type="text" id="buscar-producto" placeholder="Buscar producto..." autocomplete="off">
    <ul id="sugerencias-productos"></ul>

    <table border="1" width="100%" id="tabla-productos" style="margin-top: 10px;">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <!-- Las filas se llenan con JS -->
        </tbody>
    </table>

    <input type="hidden" name="productos_data" id="productos-data">

    <!-- ======================= -->
    <!--   TOTAL GENERAL         -->
    <!-- ======================= -->
    <h3>Total: $<span id="total-general">{{ form.instance.precio_total|default:"0.00" }}</span></h3>

    <hr>

    <!-- ======================= -->
    <!--   PAGO (anticipo)       -->
    <!-- ======================= -->
    <h3>Pago</h3>
    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 10px;">
        <div>
            <label for="anticipo">Anticipo:</label><br>
            <input type="number" step="0.01" name="anticipo" id="anticipo" value="{{ form.instance.anticipo|default:"0.00" }}">
        </div>
        <div>
            <label>Restante:</label><br>
            <input type="text" id="restante" readonly style="background: #eee;" value="{{ form.instance.precio_total|default:"0.00"|floatformat:2 }}">
        </div>
    </div>

    <input type="hidden" name="precio_total" id="precio-total" value="{{ form.instance.precio_total|default:"0.00" }}">

    <div style="margin-top: 10px;">
    <label for="comentarios"><strong>Comentarios</strong></label><br>
    <textarea name="comentarios"
              id="comentarios"
              rows="3"
              style="width:100%;"
              placeholder="Comentarios adicionales">{{ form.instance.comentarios|default:'' }}</textarea>
    </div>

    {% if user.groups.all.0.name == "Administrador" %}
<div>
    {{ form.cargador.label_tag }}
    {{ form.cargador }}
</div>
{% endif %}



    <button type="submit"
            {% if form.instance.estado_entrega == "EN_RUTA" or form.instance.estado_entrega == "ENTREGADO" %}
disabled
{% endif %}
    >
    Guardar
    </button>
</form>


<!-- ======================= -->
<!-- ======= SCRIPTS ======= -->
<!-- ======================= -->

<script>
// ===== AUTOCOMPLETAR CLIENTE =====
document.getElementById("cliente-input").addEventListener("input", function() {
    const q = this.value;
    if (q.length < 2) return document.getElementById("sugerencias-clientes").innerHTML = "";

    fetch(`/api/clientes/?q=${q}`)
        .then(res => res.json())
        .then(data => {
            const lista = document.getElementById("sugerencias-clientes");
            lista.innerHTML = "";
            data.forEach(cliente => {
                const li = document.createElement("li");
                li.style.cursor = "pointer";
                li.textContent = `${cliente.nombre} (${cliente.telefono})`;
                li.addEventListener("click", () => {
                    document.getElementById("cliente-input").value = cliente.nombre;
                    document.getElementById("cliente-id").value = cliente.id;
                    document.getElementById("calle_y_numero").value = cliente.calle_y_numero || '';
                    document.getElementById("colonia").value = cliente.colonia || '';
                    document.getElementById("ciudad_o_municipio").value = cliente.ciudad_o_municipio || '';
                    lista.innerHTML = "";
                });
                lista.appendChild(li);
            });
        });
});

// ===== AUTOCOMPLETAR PRODUCTOS =====
document.getElementById("buscar-producto").addEventListener("input", function () {
    const q = this.value.trim();
    if (q.length < 2) return document.getElementById("sugerencias-productos").innerHTML = "";

    fetch(`/api/productos/?q=${q}`)
        .then(res => res.json())
        .then(data => {
            const lista = document.getElementById("sugerencias-productos");
            lista.innerHTML = "";
            data.forEach(prod => {
                const li = document.createElement("li");
                li.style.cursor = "pointer";
                li.textContent = `${prod.nombre} - $${prod.precio}`;
                li.addEventListener("click", () => agregarProductoTabla(prod));
                lista.appendChild(li);
            });
        });
});

// ===== AGREGAR PRODUCTO A LA TABLA =====
function agregarProductoTabla(prod) {
    const tbody = document.querySelector("#tabla-productos tbody");
    const cantidad = prod.cantidad || 1;

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td data-id="${prod.id}">${prod.nombre}</td>
        <td>
            <input type="number"
                   class="precio-unitario"
                   value="${prod.precio}"
                   step="0.01"
                   style="width: 80px;">
        </td>
        <td><input type="number" value="${cantidad}" min="1" class="cantidad" style="width: 60px;"></td>
        <td class="subtotal">${(prod.precio * cantidad).toFixed(2)}</td>
        <td><button type="button" class="eliminar">‚ùå</button></td>
    `;
    tbody.appendChild(tr);

    tr.querySelector(".cantidad").addEventListener("input", actualizarTotal);
    tr.querySelector(".precio-unitario").addEventListener("input", actualizarTotal); // üî• nuevo
    tr.querySelector(".eliminar").addEventListener("click", () => {
        tr.remove();
        actualizarTotal();
    });

    document.getElementById("sugerencias-productos").innerHTML = "";
    document.getElementById("buscar-producto").value = "";

    actualizarTotal();
}

// ===== RECALCULAR TOTAL =====
function actualizarTotal() {
    let total = 0;
    let productos = [];

    document.querySelectorAll("#tabla-productos tbody tr").forEach(row => {
    const id = row.children[0].dataset.id;
    const nombre = row.children[0].textContent;
    const precio = parseFloat(row.querySelector(".precio-unitario").value); // üî• ahora editable
    const cantidad = parseInt(row.querySelector(".cantidad").value);
    const subtotal = precio * cantidad;

    row.querySelector(".subtotal").textContent = subtotal.toFixed(2);
    total += subtotal;

    if (id) {
        productos.push({
            id: parseInt(id),
            nombre,
            precio_unitario: precio, // üî• enviamos al backend
            cantidad,
            nota: row.querySelector(".nota")?.value || ""
        });
    }
});

    document.getElementById("total-general").textContent = total.toFixed(2);
    document.getElementById("precio-total").value = total.toFixed(2);
    document.getElementById("productos-data").value = JSON.stringify(productos);

    calcularRestante();
}

// ===== CALCULAR RESTANTE =====
document.getElementById("anticipo").addEventListener("input", calcularRestante);
function calcularRestante() {
    const total = parseFloat(document.getElementById("precio-total").value || 0);
    const anticipo = parseFloat(document.getElementById("anticipo").value || 0);
    document.getElementById("restante").value = (total - anticipo).toFixed(2);
}

// ===== PRECARGAR PRODUCTOS AL EDITAR =====
document.addEventListener('DOMContentLoaded', function() {
    {% if renta %}
        const productos = JSON.parse('{{ productos_data|escapejs }}');
        productos.forEach(prod => {
            agregarProductoTabla({
                id: prod.id,
                nombre: prod.nombre,
                precio: prod.precio_unitario,
                cantidad: prod.cantidad
            });
        });
        actualizarTotal();
    {% endif %}
});
</script>


{% endblock %}