{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/styles.css' %}">

<h2>{% if editando %}Editar Renta{% else %}Nueva Renta{% endif %}</h2>

<form method="POST" id="renta-form">
    {% csrf_token %}

    <!-- ===== CLIENTE ===== -->
    <div class="mb-3">
        <label for="cliente-input" class="form-label">Cliente (teléfono)</label>
        <input type="text" id="cliente-input" name="cliente" class="form-control"
               placeholder="Escribe el teléfono del cliente"
               value="{% if renta %}{{ renta.cliente.telefono }} - {{ renta.cliente.nombre }}{% endif %}">
    </div>
    <input type="hidden" name="cliente_id" id="cliente-id"
           value="{% if renta %}{{ renta.cliente.id }}{% endif %}">

    <!-- ===== FECHA Y HORARIO ===== -->
    <div class="row mb-3">
        <div class="col">
            <label class="form-label">Fecha</label>
            {{ form.fecha_renta }}
        </div>
        <div class="col">
            <label class="form-label">Hora inicio</label>
            {{ form.hora_inicio }}
        </div>
        <div class="col">
            <label class="form-label">Hora fin</label>
            {{ form.hora_fin }}
        </div>
    </div>

    <!-- ===== DIRECCIÓN ===== -->
    <div class="mb-3">
        <label class="form-label">Calle y número</label>
        <input type="text" name="calle_y_numero" id="calle_y_numero" class="form-control"
               value="{% if renta %}{{ renta.calle_y_numero }}{% endif %}">
    </div>

    <div class="row mb-3">
        <div class="col">
            <label class="form-label">Colonia</label>
            <input type="text" name="colonia" id="colonia" class="form-control"
                   value="{% if renta %}{{ renta.colonia }}{% endif %}">
        </div>
        <div class="col">
            <label class="form-label">Ciudad / Municipio</label>
            <input type="text" name="ciudad_o_municipio" id="ciudad_o_municipio" class="form-control"
                   value="{% if renta %}{{ renta.ciudad_o_municipio }}{% endif %}">
        </div>
    </div>

    <div class="mb-3">
        <label class="form-label">Comentarios</label>
        <textarea name="comentarios" id="comentarios" class="form-control">{% if renta %}{{ renta.comentarios }}{% endif %}</textarea>
    </div>

    <!-- ===== ANTICIPO ===== -->
    <div class="mb-3">
        <label class="form-label">Anticipo</label>
        <input type="number" step="0.01" name="anticipo" id="anticipo"
               class="form-control" value="0">
    </div>

    <div class="mb-3">
        <label class="form-label">Método de pago del anticipo</label>
        <select name="metodo_pago_anticipo" id="metodo_pago_anticipo" class="form-select">
            <option value="efectivo">Efectivo</option>
            <option value="transferencia">Transferencia</option>
        </select>
    </div>

    <div class="mb-3" id="cuenta_anticipo_container" style="display:none;">
        <label class="form-label">Cuenta destino</label>
        <select name="cuenta_anticipo" class="form-select">
            <option value="">-- Selecciona una cuenta --</option>
            {% for c in cuentas %}
                <option value="{{ c.id }}">{{ c.banco }} - {{ c.nombre }}</option>
            {% endfor %}
        </select>
    </div>

    <hr>

    <!-- ===== PRODUCTOS ===== -->
    <h4>Productos</h4>
    <table class="table table-bordered" id="productos-table">
        <thead class="table-light">
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <input type="hidden" name="productos_data" id="productos_data">

    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
            data-bs-target="#modalAgregarProducto">
        Agregar Producto
    </button>

    <div>
        <button type="submit" class="btn btn-success">Guardar Renta</button>
        <a href="{% url 'lista_rentas' %}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

<!-- ===== MODAL PRODUCTOS ===== -->
<div class="modal fade" id="modalAgregarProducto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="producto-busqueda" class="form-control"
                       placeholder="Buscar producto">
                <ul class="list-group mt-2" id="lista-productos"
                    style="max-height:200px; overflow-y:auto;"></ul>

                <div class="mt-3">
                    <label>Cantidad</label>
                    <input type="number" id="cantidad-producto" class="form-control" min="1" value="1">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    /* ===============================
       DATA DESDE DJANGO
    =============================== */
    let clientes = {{ clientes_json|safe }};
    let productosCatalogo = {{ productos_catalogo_json|safe }};
    let productos = {{ productos_data|default:"[]"|safe }};

    /* ===============================
       ANTICIPO / CUENTAS
    =============================== */
    const metodoPago = document.getElementById('metodo_pago_anticipo');
    const cuentaDiv = document.getElementById('cuenta_anticipo_container');
    const anticipoInput = document.getElementById('anticipo');

    function toggleCuenta() {
        if (parseFloat(anticipoInput.value) > 0 && metodoPago.value === 'transferencia') {
            cuentaDiv.style.display = 'block';
        } else {
            cuentaDiv.style.display = 'none';
        }
    }

    metodoPago.addEventListener('change', toggleCuenta);
    anticipoInput.addEventListener('input', toggleCuenta);
    toggleCuenta();

    /* ===============================
       AUTOCOMPLETE CLIENTE
    =============================== */
    const clienteInput = document.getElementById('cliente-input');
    const clienteIdInput = document.getElementById('cliente-id');

    clienteInput.addEventListener('blur', function () {
        const txt = this.value.toLowerCase().trim();
        if (!txt) return;

        const matches = clientes.filter(x =>
            x.telefono.includes(txt) ||
            x.nombre.toLowerCase().includes(txt)
        );

        // ✅ SOLO si hay un match exacto
        if (matches.length === 1) {
            const c = matches[0];

            clienteIdInput.value = c.id;
            document.getElementById('calle_y_numero').value = c.calle_y_numero || '';
            document.getElementById('colonia').value = c.colonia || '';
            document.getElementById('ciudad_o_municipio').value = c.ciudad_o_municipio || '';
            this.value = `${c.telefono} - ${c.nombre}`;
        }
    });

    /* ===============================
       MODAL PRODUCTOS
    =============================== */
    const listaProductos = document.getElementById('lista-productos');
    const busquedaProducto = document.getElementById('producto-busqueda');
    const cantidadProducto = document.getElementById('cantidad-producto');

    busquedaProducto.addEventListener('input', function () {
        const txt = this.value.toLowerCase();
        listaProductos.innerHTML = '';

        productosCatalogo
            .filter(p => p.nombre.toLowerCase().includes(txt))
            .forEach(p => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action';
                li.textContent = `${p.nombre} ($${p.precio})`;

                li.onclick = () => {
                    productos.push({
                        id: p.id,
                        nombre: p.nombre,
                        cantidad: parseInt(cantidadProducto.value) || 1,
                        precio_unitario: p.precio
                    });
                    renderProductos();
                    busquedaProducto.value = '';
                    listaProductos.innerHTML = '';
                };

                listaProductos.appendChild(li);
            });
    });

    /* ===============================
       TABLA PRODUCTOS
    =============================== */
    function renderProductos() {
        const tbody = document.querySelector('#productos-table tbody');
        tbody.innerHTML = '';

        productos.forEach((p, i) => {
            const sub = (p.cantidad * p.precio_unitario).toFixed(2);

            tbody.innerHTML += `
                <tr>
                    <td>${p.nombre}</td>
                    <td>
                        <input type="number" class="form-control cantidad"
                               data-i="${i}" value="${p.cantidad}">
                    </td>
                    <td>
                        <input type="number" class="form-control precio"
                               data-i="${i}" value="${p.precio_unitario}">
                    </td>
                    <td>$${sub}</td>
                    <td>
                        <button type="button"
                                class="btn btn-danger btn-sm del"
                                data-i="${i}">X</button>
                    </td>
                </tr>`;
        });

        document.getElementById('productos_data').value = JSON.stringify(productos);
    }

    document.querySelector('#productos-table').addEventListener('input', e => {
        const i = e.target.dataset.i;
        if (i === undefined) return;

        if (e.target.classList.contains('cantidad')) {
            productos[i].cantidad = parseInt(e.target.value) || 1;
        }
        if (e.target.classList.contains('precio')) {
            productos[i].precio_unitario = parseFloat(e.target.value) || 0;
        }
        renderProductos();
    });

    document.querySelector('#productos-table').addEventListener('click', e => {
        if (e.target.classList.contains('del')) {
            productos.splice(e.target.dataset.i, 1);
            renderProductos();
        }
    });

    /* ===============================
       ABRIR TICKET AL CREAR RENTA
    ================================ */
    const params = new URLSearchParams(window.location.search);
    const rentaCreada = params.get('renta_creada');

    if (rentaCreada) {
        const urlTicket = "{% url 'ticket_pdf' 0 %}".replace("/0/", "/" + rentaCreada + "/");
        window.open(urlTicket, '_blank');

        // limpiar URL para que no se vuelva a abrir al refrescar
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    renderProductos();
});
</script>

{% endblock %}
