{% extends 'core/base.html' %}
{% block content %}

<h2>Lista de Rentas</h2>

<!-- BotÃ³n Nueva Renta y Crear Ruta -->
<div style="margin-bottom: 20px;">
    <a href="{% url 'nueva_renta' %}"
       style="display:inline-block;width:50px;height:50px;background-color:#FF9800;color:white;font-size:28px;font-weight:bold;text-align:center;line-height:50px;border-radius:8px;text-decoration:none;transition:background-color 0.3s;"
       onmouseover="this.style.backgroundColor='#fb8c00';"
       onmouseout="this.style.backgroundColor='#FF9800';"
       title="Nueva Renta">
       +
    </a>
    <a href="{% url 'crear_ruta' %}"
       style="display:inline-block;width:50px;height:50px;background-color:#4CAF50;color:white;font-size:28px;font-weight:bold;text-align:center;line-height:50px;border-radius:8px;text-decoration:none;transition:background-color 0.3s;"
       onmouseover="this.style.backgroundColor='#45a049';"
       onmouseout="this.style.backgroundColor='#4CAF50';"
       title="Crear Ruta">
       +
    </a>
</div>

<!-- Filtros de bÃºsqueda -->
<form method="get" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
    <input type="text" name="q" placeholder="Buscar por cliente o folio..." value="{{ query }}">
    <input type="date" name="fecha" value="{{ fecha }}">
    <button type="submit" class="btn btn-primary btn-sm">Buscar</button>
    <a href="{% url 'lista_rentas' %}" class="btn btn-secondary btn-sm">Limpiar</a>
</form>

<!-- Tabla de rentas -->
<table border="1" width="100%">
    <thead>
        <tr>
            <th>Folio</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Hora inicio</th>
            <th>Hora fin</th>
            <th>Total</th>
            <th>Acciones</th>
            <th>Estatus</th>
            <th>Cargador</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        {% for renta in page_obj %}
        <tr>
            <td>
                <a href="{% url 'ticket_pdf' renta.id %}" target="_blank">
                    {{ renta.folio }}
                </a>
            </td>
            <td>{{ renta.cliente.nombre }}</td>
            <td>{{ renta.fecha_renta }}</td>
            <td>{{ renta.hora_inicio }}</td>
            <td>{{ renta.hora_fin }}</td>
            <td>{{ renta.precio_total }}</td>

            <!-- ACCIONES -->
            <td>
                {% if not renta.pagado %}
                    <a href="{% url 'editar_renta' renta.id %}" style="background:#2196F3;color:white;padding:5px 8px;border-radius:3px;">âœï¸</a>
                {% endif %}

                {% if renta.estado_entrega != 'ENTREGADO' and renta.estado_entrega != 'CANCELADO' %}
                <form method="post" action="{% url 'cancelar_renta' renta.id %}" style="display:inline;" onsubmit="return confirm('Â¿Deseas cancelar esta renta?');">
                    {% csrf_token %}
                    <button class="btn btn-danger btn-sm">âŒ Cancelar</button>
                </form>
                {% endif %}

                {% if es_cargador and renta.cargador == user %}
                    {% if renta.estado_entrega == 'ASIGNADO' %}
                        <a href="{% url 'marcar_en_ruta' renta.id %}" style="background:#ff9800;color:white;padding:5px 8px;border-radius:4px;">ğŸšš</a>
                    {% elif renta.estado_entrega == 'EN_RUTA' %}
                        <a href="{% url 'marcar_entregado' renta.id %}" style="background:#4caf50;color:white;padding:5px 8px;border-radius:4px;">âœ…</a>
                    {% endif %}
                {% endif %}
            </td>

            <!-- ESTATUS ADMIN -->
            <td>
                {% if renta.status == 'ACTIVO' %}
                    <span style="color:green;font-weight:bold;">ACTIVO</span>
                {% else %}
                    <span style="color:red;font-weight:bold;">CANCELADO</span>
                {% endif %}
            </td>

            <!-- CARGADOR -->
            <td>
                {% if not renta.cargador %}
                    <a href="{% url 'asignar_cargador' renta.id %}" style="background:#2196F3;color:white;padding:5px 8px;border-radius:4px;text-decoration:none;">Asignar cargador</a>
                {% else %}
                    {{ renta.cargador.username }}
                {% endif %}
            </td>

            <!-- ESTADO ENTREGA -->
            <td>
                {% if renta.cargador %}
                    {% if renta.estado_entrega == 'ASIGNADO' %} ğŸŸ¡ Asignado
                    {% elif renta.estado_entrega == 'EN_RUTA' %} ğŸ”µ En ruta
                    {% elif renta.estado_entrega == 'ENTREGADO' %} ğŸŸ¢ Entregado
                    {% endif %}
                {% else %}
                    <span style="color:#999;">Pendiente</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- PaginaciÃ³n -->
<nav aria-label="Page navigation" style="margin-top: 20px;">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if fecha %}&fecha={{ fecha }}{% endif %}">Anterior</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if fecha %}&fecha={{ fecha }}{% endif %}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if fecha %}&fecha={{ fecha }}{% endif %}">Siguiente</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
        {% endif %}
    </ul>
</nav>

{% endblock %}
